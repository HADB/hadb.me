---
title: Maven é¡¹ç›® Docker ä¸€é”®å‘å¸ƒé…ç½®
date: 2018-04-12
tags: ['æŠ€æœ¯', 'Docker', 'DevOps']
---

> 2018 å¹´ 04 æœˆ 12 æ—¥ å°é›¨ğŸŒ¦

Docker ç”¨äº†å¾ˆä¹…äº†ï¼Œä¹‹å‰ Maven é¡¹ç›®ä¸€ç›´ç”¨çš„[docker-maven-plugin](https://github.com/spotify/docker-maven-plugin)ï¼Œä½†æ˜¯ä½œè€…ç›®å‰å·²ç»ä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼äº†ï¼Œè¯¥é¡¹ç›®å·²ç»ä¸å†æ›´æ–°åŠŸèƒ½ï¼Œåªæä¾› bugfixã€‚ä»–ä»¬çš„æ–°é¡¹ç›®å«åš[dockerfile-maven](https://github.com/spotify/dockerfile-maven)ï¼Œé…ç½®ä¸Šæœ‰äº›ä¸åŒï¼Œä¹‹å‰ä¸€ç›´æ²¡æ—¶é—´å»æ›´æ–°ï¼Œæœ€è¿‘çš„ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œé‡‡ç”¨äº†æœ€æ–°çš„æ’ä»¶ï¼Œä¸­é—´ä¹Ÿè¸©è¿‡ä¸å°‘å‘ï¼Œåˆšåˆšç»ˆäºéƒ½æå®šäº†ï¼Œè®°å½•ä¸€ä¸‹ã€‚

Dockerfile æ— éœ€å¤šè¯´ï¼Œæ•´ç†äº†ä¸€ä¸ªé€šç”¨çš„ï¼Œå¯ä»¥ç”¨åœ¨ä»»æ„ Spring Boot é¡¹ç›®ä¸­ï¼Œå¦‚ä¸‹ï¼š

```dockerfile
FROM frolvlad/alpine-oraclejdk8:slim

RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

VOLUME /tmp

ARG JAR_FILE
ADD ${JAR_FILE} app.jar
RUN sh -c 'touch /app.jar'
ENV JAVA_OPTS=""
ENV ENV=""
ENTRYPOINT [ "sh", "-c", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app.jar --spring.profiles.active=$ENV" ]
```

åœ¨ç”¨é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡çš„æ—¶å€™ï¼Œè¿™é‡Œçš„`ENV`å¯ä»¥ç›´æ¥æ˜¾ç¤ºåˆ°é…ç½®é¡¹ä¸­è¿›è¡Œé…ç½®ï¼Œæ ¹æ®ä¸åŒçš„é…ç½®é€‰æ‹©ä¸åŒçš„ profiles æ–‡ä»¶ã€‚

`pom.xml`æ–‡ä»¶ä¸­ï¼ŒåŠ å…¥`plugin`ï¼Œä¼šè‡ªåŠ¨æ·»åŠ ç‰ˆæœ¬å·å’Œ`latest`ä¸¤ä¸ª`tag`ï¼Œå¹¶æ¨é€ã€‚

```xml
<plugin>
    <groupId>com.spotify</groupId>
    <artifactId>dockerfile-maven-plugin</artifactId>
    <version>1.4.0</version>
    <executions>
        <execution>
            <id>build-image</id>
            <phase>package</phase>
            <goals>
                <goal>build</goal>
            </goals>
        </execution>
        <execution>
            <id>tag-image-version</id>
            <phase>deploy</phase>
            <goals>
                <goal>tag</goal>
                <goal>push</goal>
            </goals>
            <configuration>
                <tag>${project.version}</tag>
            </configuration>
        </execution>
        <execution>
            <id>tag-image-latest</id>
            <phase>deploy</phase>
            <goals>
                <goal>tag</goal>
                <goal>push</goal>
            </goals>
            <configuration>
                <tag>latest</tag>
            </configuration>
        </execution>
    </executions>
    <configuration>
        <repository>registry.cn-hangzhou.aliyuncs.com/xxx/${project.artifactId}</repository>
        <tag>${project.version}</tag>
        <useMavenSettingsForAuth>true</useMavenSettingsForAuth>
        <buildArgs>
            <JAR_FILE>target/${project.build.finalName}.jar</JAR_FILE>
        </buildArgs>
    </configuration>
</plugin>

```

æƒ³è¦ç›´æ¥ç”¨`mvn deploy`å®Œæˆæ•´ä¸ªéƒ¨ç½²çš„è¯ï¼Œè¿˜éœ€è¦åŠ ä¸€ä¸‹ Nexus çš„å‘å¸ƒé…ç½®

```xml
<distributionManagement>
    <repository>
        <id>monkey-run-maven-release</id>
        <name>MonkeyRun Maven Release Repository</name>
        <url>ä½ çš„nexusä»“åº“åœ°å€</url>
    </repository>
</distributionManagement>
```

é˜¿é‡Œäº‘å®¹å™¨ä¸Šé…ç½®å¥½é•œåƒæ›´æ–°é‡æ–°éƒ¨ç½²çš„è§¦å‘å™¨ï¼Œä¹‹åå°±æ˜¯ç›´æ¥`mvn deploy`ç­‰ç¼–è¯‘å¥½ä¸Šä¼ å®Œå°±å‘å¸ƒå®Œæˆå•¦ï¼
